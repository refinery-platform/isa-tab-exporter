language: python
cache: pip
sudo: required
python:
  - 3.6

stages:
  - name: deploy
    if: branch = master

env:
  global:
  - TERRAFORM_VERSION=0.11.10
  - AWS_DEFAULT_REGION="us-east-1"
  # AWS_ACCESS_KEY_ID
  - secure: "HV10gO4GDi5Im3EZjG0kM3qZfoS7WRwcwDzUFWP8a9iSiNnON6awSWFmIMN6nu1BrCpjQidsBJFk0+e3yu35IELWaC/j9hjMLErLBX/nzSuxUrPXFnbRW6iJTcP2w1OJM+bI07lmooVi3meUIhS+zcqDDM+rywuFr17/SKx22rOribE7rqKbv2IEzIW6LHB0zXqM22QNb8Rpch/SGoZFGg5vpVepjJbaA2K33TCx3b5i3O+uOezxFTUBXKwzhDFIpoj/FrAzRwZjoK5tyF7of5733h8OGp/GXgRrtRqXin5GlVCOkVb4VywduhMxpVW5ZBl6psH4b8gv+48yXg+gTbl9+8ZyFvlWUWTAS/LfWqnEq7xr6R82Q9AIDKlurcBaAldWwKX2FfuCwWSHht9HUf+lWTq4bVmS7TB371wVGtP6I1quORV+ChCpjchJhJ1I0lOUVo1FQ60CiWhU3J9c5HiHS6X+RMG4vnikhFEWzLQ7MXbma17eFpkkcK1f4mL4O/YvPKBUHp+jEbStt2WLPamqV3fc2bMerYoEkZ6QKqaujtH1hR0VXGDsr6EMuZfvFlg8d9PaS5raHTNZmcKZ8rx54K4GcUNbadEp4t0kFjNE1ZHNO+5ZrCJdYhUTEXpyvQ/SkHjZzEHuL7uxI+xmzMRixLzTW+PaNbHQGagpI/c="
  # AWS_SECRET_ACCESS_KEY
  - secure: "OQcVplmfH5wOBENyin7PQnRVVeEUwxR9n9ZDx/f482kYMMxReIENj78OymRpQEMcrN2JMG4hEfIMbNszyFCRV2iLcS0/ZOwkYBidKO18gtOXkMkSXoVF9vngsrURDcBh7ywzcsC+sOvu8PB5hz/oRakvVyT3+vQyv1TmTSHU0Un9CXQOP/i9DB7DoVQtR+UA8cemVtVgF5vslPAuCtCXELCAwy7Qwdye/DSwh2SySB4IVIZ7MpdrBGKz4DlJTSjjh+9v0ZAJCrUsGiouxwtRRvRRC0vAflr+Op9DNb7V7vOPIgfYRPbtESwxwOYO36I5HOFrszOMOjP4dxZwJ3Z/olOEiTM4dIBPoGaUTeICWzdxJVH79CtvjJXsoG5rwiR0xFAxVI9kNRZqFgOsxE4bR9zllS3jo8dwtW4WvLOrSkO6LTNY+B3FEaDN4D48midqRx80qR4eoB/f7Vll30QHfhtvs7/GfoodHWTgV6bwAqz8tlEzEwgJWHswZSIihx308iMotng5pawtxCUb8alYmBRT4vra4xdszx8AvepwZBRkX1fGJn1ZP1m6gVN3BqMVold5OKkQ9d2N4n4z/SVDsLaBt/+/lP0ZMH0J9Rw4f99r6BJUzmpSEoEW0Q1cUOd9EMXWEU/ppzKHpCa/gJOwY6D815PDdUZbCBZhn+aakds="
  # ACM_CERTIFICATE_ARN
  - secure: "oLyr2mrOxyIjTbpaeazxF0G6s0KPVxfGTZT/O2OreKNT2BvY9RdGYdTzdWPl7Dztes6B4SynsF7oQGrE2wK8maw+UiSaYkZpbcbpPv6E0rSa9o4KiZ+qTSwdHLGoLTM8myaiSeKtGOip5zID0niwViY1qWvcaspOibu1g+f2EeZg+btbJL7NbtUDj3zvsHHNubSUzPvj2fAm8qwoeNaaogm7voWUxJbJK8prdNECsLH1xRgXxnBifPGWVpySGZrIENRu5A7OScAx1hanTlTz8y2Jc7kx9vCojii9RbkAZ5ICpvSAqVmHZyHaCJMfRc2D4jI9eozJKY0BgbNGWkDYiqrq7clgrXSVYbbcKW3d9U4EymkdeheMhNDS4c/v5IrIf7GuVWj422Wkj1xzPTkUo7PI39oJWbuvAxsdbpZl5SV3Ok48NscjoRtvchT6t/LsvxtqBFtZORYppIhgH4/rCkuR8tniWPBvZSjXyx8utCgURqfZaR4fe6logeCOB8njmOCGtTSQWtq7JTT3SrYIELP/1m78XYoqcSxAKFgidcZKgB5OYSTRVt6OBvpY9LBn4a3BkIt2ZjUhzf3Uc97QLBahtlhm0fCWuJ/LT4Z9nTvxFxMpvhB8ZNIJCMU6qOCzUbYjm/ykIzcxNZzUQ4dCVWOVCFIJuraM0qbMF3UXOcM="
  # ROUTE_53_HOSTED_ZONE_ID
  - secure: "ThCSxPEiB39VRfGpQyW5zrDGfCaK3gsleNeq/HKqmsibayuVmU7puUK/CJNlcbeVYJnjRDJeFLaoF6G49vMvoDJkhNErQ5EfalNNrNtfMYNv4yTVtyovpLczTgP1e/2Cq+4BBjnOb5KsBN2ix+wYEfl7pURfEIrSeV93yO1NaXdHg4BIVYQa6I8Or87PxcYp0zXwcvyJsBOpDA3PqaG2UQ9ziSeKVdw6O6OCE5gDK5QH44H9rf9u/1fxaBs3Ty6sW9QtqAfdarEST0DJyUMFA00ByHalnj5c4ThYIC3aCEYXkUqrrFD2H8ICDVSV/4liFn8fOKYkpk9nVs2simHVTexyYTUq9lvmKdExZQYsm+OTYL8AsHRGO2t+IFzd7Eu2aeFjuMj1nAWvqxg2I0MArTbZexsQPH54jpGhGT8Iqesqw4I6AHP8J3W1uTFozYohJ+65ksjz5Z/Q4GGphs0SluIuQolG+o/7KozozhPnEHPlJA6tw4dVTgaMLpF6TOZKfruHYxfeB90oafcD9edaBM3RXAYU6aEojjT1L3pRS3YtScfZpvueMv/8JwG3kUhHGaasoPe+GybthwZI6zUYDsxOB5txuanQfmIqQsCdT9xtP/jDl4bZ85rnbxINrSEO4w/+v3roAW0a2yDuyMg4NfZaaUnInG1OW0MnLbmXDYo="

install:
  # Install terraform
  - curl -fSL "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip" -o terraform.zip
  - sudo unzip terraform.zip -d /opt/terraform
  - sudo ln -s /opt/terraform/terraform /usr/bin/terraform
  - rm -f terraform.zip

  # Install reqs for testing
  - pip install -r requirements-test.txt

script:
  - black --check --diff .
  - flake8

  - nosetests

  - pushd terraform
  - terraform init -input=false
  - terraform validate
  - terraform fmt -check=true -diff=true
  - popd

after_success:
  - codecov

deploy:
  provider: script
  script: bash deploy.sh