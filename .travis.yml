language: python
cache: pip
sudo: required
python:
  - 3.6

stages:
  - name: deploy
    if: branch = master

env:
  global:
  - TERRAFORM_VERSION=0.11.10
  - AWS_DEFAULT_REGION=us-east-1
  # AWS_ACCESS_KEY_ID
  - secure: cfhDDpmw3SFM2CncvZM716jHbdGSafoye1CfciZHL/bHJzMxog4R+p20+v/9oKrvNeGcJK37t0bY55AhBKDMDgOqwOp2yeEczn1Aw/4EQ55emBji4QZ2OI65OTISpLXYt8dGqhX6F4I5GCaW0KW36KNoa1ISSZrOpcLW5gzMdDZ/23JQWkLZRVQNTI2MAfOOD2DnS3pC+H90YPeBY4ofe8/7oupLH2xrgXPzkeE4BS3VwI5g2DnY4SVFs8OPK7kMyJE2AITABCD9fwSostkQziHTh3JGg2NAMzPZdGF6eenET4lpqf7/4pf8nTJWq0lFgxUfolN/4SInzWXNw8nrnXJiS2jfv0SfxdQI988v33lsIHd5D7B2vCviBqbyfkqlAXTojtblaFSyR7uoRWZIvWaR4RF4RYrRhYLBAXbj7SGPcAP4GRFecTJUjPDMs5L5//d/LC/J38HdVj9AdG1RT/V3ynDPXSA2yKnGFIFQ4u7ZnawUr3BbBF9LxidTvPz4YE6hPTBu3aL8rpxmzWhhc8dPdm0lyCGmMQtdEM3igz+UI58mzHqsxVfvd+VgpFVQN8hMcObfUBlk87G81UXXbums1t8M16od/exOmMnj63fK4X0+SCH7o1d5fV5KhGIlsiUprdKomyewGJEW8iKwzoeJLQBZyYYdeXrsCK+3Kpo=
  # AWS_SECRET_ACCESS_KEY
  - secure: PpfvrC1b6qLx1LtKOFr+NQXB0hP30qETJU5rKbmEKpi8q8CsnezhXyqooq++4fegdG+9/bgRvKl8qEj6BNWw1MYQU6xZPb12ckQWCIpXxPi4jnCsXGOBGglP43MAVsXgK6Wgp4bN4bULZPai08679DoqBCwZG7lgVkyLU+SLH8NqiC0NOcfYWs1RujRvEWF5BQOEZ35esc/ufdfacpfQWExA9N8QRxh5ecx5Yufxk7lAsCgQNgkHP/j8z+M2Jztxdbmn6G1QUMkXWfSqUr+eVZM2z1BLtZGQe0BmLfgwSeoM0kPFGa1nk3KKVAC0EhSkKcb3NIPuPhKwLVh7rjKvC5NR+rJlARr0o+IoxkN4v/eBebEQ2A/9ZwsXlit6qHWKHBhqNCZZw8YXbcKHe8lWqFRc7qEJwxbZPo6DXvfKxHZCE2fHlKkdEgBYYHVpsm8lxpzb6zV7JjhZwiUWlpHeBb9XCe+OQk4PKKrB51nvhAsLRg8XmQwtdqHwIWobHDSRuTZZRFxfXmjRYwvP52679FOjcX4kh0GZaW1Zw9ElSs/flAx0MJcs9/fbe3PYuRRzVVcBzASWzxNPMPupiquHj8WxgJMoeikWA/iD7u+dWX9sFOzfr2paPhcmkqbptUrKDaPxAUcoCWwNY2701zyFSSdqEpdNbe/eekb361UWpTM=
  # ACM_CERTIFICATE_ARN
  - secure: s8VqQZL5WbCft8oncheF5Xgo8XX9mV+sH7x7zG4u9C/+7AWqOH2v4XU8rf6Eg9PLusO7EmEFfKFrCODtMH1ux3aP1ziXmIJ9KDXXIcvCjKJKYsXSgARa4N/8bYOXwg2NF8YlEId83SF0HQqTbghf9S6EHnGKa5M3ZDohEsdb8TOG6nEn0qIEn1QnB/FkAYKyz9KV0U96nA6lvmj2zZEXU5xB4UIb7SZxehcLoCBr+4FND4j1otaYQ2CPlQf4ESLzvbRiHRfyoiBeW/n+F+rPiTXrMuS0Cz+wrbnzAt9Bayp96eVSPpQIKsGB6HaZQzFLfUTgguuNUcJc0mY87lpqIuVJhIkFdlat/OsWi5B741Bp0dTreQP3DpDgwLw4hZAvV7zAZocl4sqR5mBOLX0Q/F1ETU5d4STv3XUm5UF+jtDbHhEI+6UAUKEoAIuzrVG/0T1tTE4YpNNq/+7wMIayTL1UfiYMngHSKwcrunciloPPU10H0arJ2CMa/v2u2SjBvbihcxXJJR5nUeS8zy/OsOXzYGUGAHh1DtzcAOQjw7+SCquJgutnbPgF0x3v87tmsgN0dRRl8iV5te6aQMQKOKyj+flScrLnXo+9BFmu3eFX523yjOZxmTaJ4VKK3NUM7TKPcSKT/If5+vUhmRI5XapRdvcP1mU9yHaUm/FDi54=
  # ROUTE_53_HOSTED_ZONE_ID
  - secure: bEmMhizfOGPg/C0LE7I0NRvOpLxxWlHayTCg+5biwxULW+bcvWGvT9OMcBLSjaauCj/fAIvMFhI3EsffKl33cQvtxRXh2pcis/HKe4xblhjxy2s7e2eb1XwOIwidHa4+6D4p7ANvHjWGq0s7B46SNNoXN7nXxxvcVRpbAaVNkJQjNjvGjZQrlAq5veojgRWIQWPIBFp0UyVcdwacJZX531dFfxufvDQDTMMAcbWrwToOLyQ5Mfh5FjTX0nWd1b+s/PR0zDjQcOqv5F3sIDsPxPHNEeIWNOph+8wFs/0zw1BTTLYgo1u1h551TrPoOQi7GVyLqkZ6bDmw9mY05hT7NFJgft0GMV6pJo8eZWCrkP6UPvD+e0R/Z96TyZWvN88V/z+59kzYgZosBoXZBH22dUuRspIx+3R9O6mA0hxwsG+aQx2fbetoYHnST8pQ4sDKYOmWvfO/7N1l9EoUcm3DaPfUNW9HEXfFBsKGboVu+vwalTKQgHu2s46xuq87uv411QhpFcURxtnDMz26d3+q4iHcTgfJAMXLyfPG7Kl9NWQPCApXxwfAlCA5WUu1HR5Nr/7eA4pWoLSuq6LeFGKszN5AmHodybHiRG1USn0rTdpTy8B/YC0NtvdKkD67pv1yRHWzNZIgzs5xyg45XI8JxGhG87DCFyhyYh8jARsOHxg=

before_install:
  # https://github.com/travis-ci/travis-ci/issues/7940#issuecomment-311411559
  - export BOTO_CONFIG=/dev/null

install:
  # Install terraform
  - curl -fSL "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip" -o terraform.zip
  - sudo unzip terraform.zip -d /opt/terraform
  - sudo ln -s /opt/terraform/terraform /usr/bin/terraform
  - rm -f terraform.zip

  # Install reqs for testing
  - pip install -r requirements-test.txt

script:
  - black --check --diff .
  - flake8

  - nosetests

  - pushd terraform
  - terraform init
  - terraform validate
  - terraform fmt -check=true -diff=true
  - terraform plan -detailed-exitcode
  - popd

after_success:
  - codecov

deploy:
  provider: script
  script: bash deploy.sh