language: python
cache: pip
sudo: required
python:
  - 3.6

stages:
  - name: deploy
    if: branch = master

env:
  global:
  - TERRAFORM_VERSION=0.11.10
  # ACM_CERTIFICATE_ARN
  - secure: "oLyr2mrOxyIjTbpaeazxF0G6s0KPVxfGTZT/O2OreKNT2BvY9RdGYdTzdWPl7Dztes6B4SynsF7oQGrE2wK8maw+UiSaYkZpbcbpPv6E0rSa9o4KiZ+qTSwdHLGoLTM8myaiSeKtGOip5zID0niwViY1qWvcaspOibu1g+f2EeZg+btbJL7NbtUDj3zvsHHNubSUzPvj2fAm8qwoeNaaogm7voWUxJbJK8prdNECsLH1xRgXxnBifPGWVpySGZrIENRu5A7OScAx1hanTlTz8y2Jc7kx9vCojii9RbkAZ5ICpvSAqVmHZyHaCJMfRc2D4jI9eozJKY0BgbNGWkDYiqrq7clgrXSVYbbcKW3d9U4EymkdeheMhNDS4c/v5IrIf7GuVWj422Wkj1xzPTkUo7PI39oJWbuvAxsdbpZl5SV3Ok48NscjoRtvchT6t/LsvxtqBFtZORYppIhgH4/rCkuR8tniWPBvZSjXyx8utCgURqfZaR4fe6logeCOB8njmOCGtTSQWtq7JTT3SrYIELP/1m78XYoqcSxAKFgidcZKgB5OYSTRVt6OBvpY9LBn4a3BkIt2ZjUhzf3Uc97QLBahtlhm0fCWuJ/LT4Z9nTvxFxMpvhB8ZNIJCMU6qOCzUbYjm/ykIzcxNZzUQ4dCVWOVCFIJuraM0qbMF3UXOcM="
  # ROUTE_53_HOSTED_ZONE_ID
  - secure: "ThCSxPEiB39VRfGpQyW5zrDGfCaK3gsleNeq/HKqmsibayuVmU7puUK/CJNlcbeVYJnjRDJeFLaoF6G49vMvoDJkhNErQ5EfalNNrNtfMYNv4yTVtyovpLczTgP1e/2Cq+4BBjnOb5KsBN2ix+wYEfl7pURfEIrSeV93yO1NaXdHg4BIVYQa6I8Or87PxcYp0zXwcvyJsBOpDA3PqaG2UQ9ziSeKVdw6O6OCE5gDK5QH44H9rf9u/1fxaBs3Ty6sW9QtqAfdarEST0DJyUMFA00ByHalnj5c4ThYIC3aCEYXkUqrrFD2H8ICDVSV/4liFn8fOKYkpk9nVs2simHVTexyYTUq9lvmKdExZQYsm+OTYL8AsHRGO2t+IFzd7Eu2aeFjuMj1nAWvqxg2I0MArTbZexsQPH54jpGhGT8Iqesqw4I6AHP8J3W1uTFozYohJ+65ksjz5Z/Q4GGphs0SluIuQolG+o/7KozozhPnEHPlJA6tw4dVTgaMLpF6TOZKfruHYxfeB90oafcD9edaBM3RXAYU6aEojjT1L3pRS3YtScfZpvueMv/8JwG3kUhHGaasoPe+GybthwZI6zUYDsxOB5txuanQfmIqQsCdT9xtP/jDl4bZ85rnbxINrSEO4w/+v3roAW0a2yDuyMg4NfZaaUnInG1OW0MnLbmXDYo="

install:
  # Install terraform
  - curl -fSL "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip" -o terraform.zip
  - sudo unzip terraform.zip -d /opt/terraform
  - sudo ln -s /opt/terraform/terraform /usr/bin/terraform
  - rm -f terraform.zip

  # Install reqs for testing
  - pip install -r requirements-test.txt

script:
  - black --check --diff .
  - flake8

  - nosetests

  - pushd terraform
  - terraform init -input=false
  - terraform validate
  - terraform fmt -check=true -diff=true
  - popd

after_success:
  - codecov

deploy:
  provider: script
  script: bash deploy.sh