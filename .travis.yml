language: python
cache: pip
sudo: required
python:
  - 3.6

env:
  global:
  - TERRAFORM_VERSION=0.11.10

install:
  # Install terraform
  - curl -fSL "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip" -o terraform.zip
  - sudo unzip terraform.zip -d /opt/terraform
  - sudo ln -s /opt/terraform/terraform /usr/bin/terraform
  - rm -f terraform.zip

  # Install reqs for testing
  - pip install -r requirements-test.txt

script:
  - flake8
  - black --check --diff .

  - nosetests

  - pushd deployment/terraform
  - terraform fmt -check=true -diff=true
  - terraform init -input=false
  - terraform validate
  - popd

after_success:
  - codecov

deploy:
  provider: script
  script: bash deployment/scripts/deploy.sh
  on:
    all_branches: true